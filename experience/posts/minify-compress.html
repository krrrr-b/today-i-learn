<!DOCTYPE html>
<html lang="kr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="krr-b 기술블로그">
  <meta name="author" content="krr-b">
  <title>민웅이서점</title>

  <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/one-page-wonder.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" crossorigin="anonymous" href="http://meta-kage.kakaocdn.net/dn/osa/blog/assets/fonts/Kakao.css"/>
  <link rel="stylesheet" type="text/css" crossorigin="anonymous" href="http://meta-kage.kakaocdn.net/dn/osa/blog/assets/fonts/SpoqaHanSans.css"/>

  <style>
    a {
      color: #000;
      text-decoration: none !important;
    }

    a:hover {
      color: #5F00FF;
    }

    .container {
      font-family: 'Spoqa Han Sans' !important, sans-serif;
      font-weight: lighter;
    }

    h2.display-5 {
      font-family: 'Kakao' !important, sans-serif;
      font-weight: lighter;
    }

    .kakao {
      font-family: 'Kakao' !important, sans-serif;
      font-weight: lighter;
    }

    .spoqa {
      font-family: 'Spoqa Han Sans' !important, sans-serif; 
      font-weight: lighter !important;
    }

    .spoqa-bold {
      font-family: 'Spoqa Han Sans' !important, sans-serif; 
      font-weight: bold !important;
    }

    .code {
      background-color: #5d5d5d;
      color: #FFF;

      font-family: 'Kakao' !important, sans-serif;
      font-weight: lighter !important;
    }

  </style>
</head>

<body style="width: 1076px !important; margin-right: 15% !important; margin-left: 15% !important;">

  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top" style="margin-right: 15% !important; margin-left: 15% !important; width: 1076px !important">
    <div class="container">
      <a class="navbar-brand spoqa" href="https://krr-b.github.io">민웅이서점</a>
    </div>
  </nav>

  <header class="masthead text-center text-white" style="background-image: url(../notebook.jpg);">
    <div class="masthead-content">
      <div class="container">
        <h1 class="masthead-heading mb-0 spoqa">정적 미디어 파일 MINIFY, COMPRESS</h1>
      </div>
    </div>
  </header>

  <section>
    <div class="container" style="margin-top: 50px; margin-bottom: 300px;">
몇개월 전에 <a href="https://krr-b.github.io/posts/saramin-ci-cd-server.html" target="_blank" style="color:#5F00FF;"><b>사람인 기술연구소 지속적인 배포/ 테스트 환경 (CI, CD) 구축</b></a> 을 하였고 그 뒤에 무엇을 해볼까 굉장히 많은 고민을 했다.
  
  <br/><br/><br/>
  <h4>1. JWT 를 활용한 인증 도입</h4><br/>
  <h4>2. Swagger 를 통한 API Docs 정리</h4>
  (Java 환경이라면 어노테이션만으로 간단히 정리할 수 있지만, Php 환경이였기 때문에 여러가지로 복잡할 것 같았다.)
  <br/><br/>

  <h4>3. 정적 미디어 파일 (HTML, CSS, Javascript) MINIFY, COMPRESS 처리</h4><br/>

위 3가지를 아이디어 중에 3번째 <b>'정적 미디어 파일 (HTML, CSS, Javascript) MINIFY, COMPRESS 처리'</b> 를 해보고자 하였다.<br/>
처리 방법은 이번에 도입하게된 <b>JENKINS 를 활용하여 빌드 시에 압축함으로써 (자동으로) 파일의 크기가 작아지는 처리가 되도록 하는 것을 목표</b>로 하였다.<br/>(메이븐을 활용하여 처리하는 방법도 있다고 한다.)
<br/><br/>

결과를 미리 정리하자면, <br/>
<b>현업에서 사용하는 정적 미디어 파일 (HTML, CSS, Javascript) 을 압축해보았는데 그 결과는 생각보다 놀라웠다.</b><br/><br/>

<font style="color:#5F00FF;">
  <b>전체 HTML 파일 용량의 30% 이상 감소<br/>
  전체 Javascript 파일 용량의 50% 이상 감소<br/>
  전체 CSS 파일 용량의 20% 이상 감소<br/></b>
</font>

<br/>

원리는 다음과 같다.<br/><br/>
<b>1. 오픈소스 플러그인을 활용하여 미디어 파일을 하나씩 압축<br/>
2. 압축된 파일은 중복으로 압축을 못하도록 문자열을 추가
</b>
<br/><br/>

단순히 잘 짜여진 라이브러리를 활용하면 되는 것이기 때문에 자동으로 실행시켜주는 스크립트를 작성해두겠다.<br/><br/>

<h4>Library: YuiCompressor</h4>
<xmp style="font-family: 'Kakao'; font-weight: lighter; font-size: 12pt; background-color: #5D5D5D; color: #FFF;">
    #!/bin/bash
    #CREATED BY JACOBS.902207
    if [ -z "$BASH_VERSION" ]; then exec bash "$0" "$@"; fi

    #파일 검색
    #js, css 확장자 포함 && .min.(css|js) 키워드 제외
    for file in find ./webroot \( -name "*.js" -o -name "*.css" \) -not -regex ".*\.min\.\(css\|js\)"
    do

      #파일 내용에 DO NOT COMPRESSING 문자열이 포함되어 있다면 제외
      if [[ -z grep "/* DO NOT COMPRESSING */" $file ]]; then
        #압축 알림
        echo "COMPRESSING $file..."

        #압축 제외
        else continue;
      fi

      #JS 확장자 압축 실행
      if [[ "$file" =~ ".js" ]]; then
        cp -rf $file $file-temp
        java -jar yuicompressor-*.jar --type js --charset UTF-8 -o $file $file

        if [[ -z $file ]]; then
          mv -f -v $file-temp $file
        else
          rm -rf $file-temp
        fi
      fi

      #CSS 확장자 압축 실행
      if [[ "$file" =~ ".css" ]]; then
        java -jar yuicompressor-*.jar --type css --charset UTF-8 -o $file $file
      fi

      #DO NOT COMPRESSING 문자열 추가
      echo " /* DO NOT COMPRESSING */ " >> $file

    done

</xmp>

<br/>

<h4>Library: HtmlCompressor</h4>
<xmp style="font-family: 'Kakao'; font-weight: lighter; font-size: 12pt; background-color: #5D5D5D; color: #FFF;">
    #!/bin/bash
    #CREATED BY JACOBS.902207
    if [ -z "$BASH_VERSION" ]; then exec bash "$0" "$@"; fi

    #파일 검색
    #html 확장자 포함
    for file in find . \( -name "*.html" -o -name "*.phtml" \)
    do

      #파일 내용에 DO NOT COMPRESSING 문자열이 포함되어 있다면 제외
      if [[ -z grep "<!-- DO NOT COMPRESSING -->" $file ]]; then

        #압축 알림
        echo "COMPRESSING $file..."

        #압축 제외
        else continue;
      fi

      #HTML 확장자 압축 실행
      java -jar htmlcompressor-*.jar --type html -o $file $file

      #DO NOT COMPRESSING 문자열 추가
      echo " <!-- DO NOT COMPRESSING --> " >> $file

    done
    
</xmp>
  
  <br/>
  위와 같은 스크립트를 서버 내에 파일로 생성해서 실행하거나 젠킨스 내에서 실행시키면 해당 글의 목적인 정적 파일들을 MINIFY, COMPRESS 할 수 있을 것이다.<br/>(<b>유연하게 사용하려면 경로 또는 처리를 변수로 받아서 사용</b>하면 더 좋을 것 같다.)

  </div>
  
</section>
</body>
</html>
